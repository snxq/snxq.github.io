---
layout: post
title: Golang QA
date: 2019-09-09 14:46:35 +0800
categories: 技术
tags: Golang
---

### 简单描述下三色标记法。

三色标记法基于标记清除的 gc 方法，初始化所有的节点为白色，然后从 root 开始扫描，引用到的节点为灰色，然后再从灰色节点扫描，并将灰色变为黑色节点，重复扫描灰色节点直到灰色节点消失，就只剩下白色和黑色节点，清除掉白色节点。

### golang 是如何优化 stw 的?

golang没有根本解决stw，只是通过并行执行标记和清除过程缩短stw的时间。

### stw 在 gc 过程中怎么触发的?

gc中有两个阶段触发了 stw。第一次是在 gc 初始化的时候，启用 gc 辅助功能和写屏障。第二次是在re-scan 中，即第一次扫描完成，在进行第二次扫描新引用的节点时。

### 什么是写屏障?

写屏障是用来在 gc 扫描的过程中，如果有新的节点被引用，那么会在引用的过程中记录下来，通知 gc，然后 gc 就不会漏掉新的被引用节点了。 

### 局部变量分配在栈还是堆上?

默认是分配在栈上的，但是如果变量存在逃逸分析，那么就必须分配到堆上。

### defer 的执行顺序。

如果有多个defer，执行顺序是**后进先出**。也就是说 defer A;defer B;那么会先执行B，再执行A。

### defer 和 return 的执行顺序。

首先，return **不是**一个原子操作，分为revl = xx;retu revl，defer的执行顺序在这两个原子操作之间，也就是revl=xx;defer xx;retu revl。

### string 和 nil。

string 是不能赋值为 nil 的，不过有个小技巧，可以使用 *string 设置为 nil 。
